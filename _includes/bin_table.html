<div id="bin-search-wrapper">
    <ul id="bin-search-filters" class="function-list">
        {% for function_item in site.data.functions %}
            {% assign function_name = function_item[0] %}
            {% assign function = function_item[1] %}
            <li><a href="#/^{{ function.label | downcase }}$" data-title="{{ function.description | replace: '\n', ' ' }}">{{ function.label }}</a></li>
        {% endfor %}
    </ul>

    <input id="bin-search" type="text" placeholder="Search among {{ site.gtfobins | size }} binaries: [<binary>][/<function>]..."/>
</div>

<div id="bin-table-wrapper">
    <table id="bin-table">
        <thead>
            <tr>
                <th>Binary</th>
                <th>Functions</th>
            </tr>
        </thead>
        <tbody>
            {% for file in site.gtfobins %}
                {% capture bin_name %}{% include get_bin_name.html path=file.path %}{% endcapture %}
                <tr data-name="{{ bin_name }}">
                    <td><a href="{{ file.url }}" class="bin-name">{{ bin_name }}</a></td>
                    <td>{% include function_list.html bin=file %}</td>
                </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr><td colspan="2">No matches!</td></tr>
        </tfoot>
    </table>
</div>

<script>
    function filter(query) {
        const queryArray = query.toLowerCase().trim().split(/ *\//);
        const binPattern = queryArray[0];
        const functionPatterns = queryArray.splice(1);
        const table = document.querySelector('#bin-table');

        // hide the table during the filtering to avoid unnecessary layout reflows
        table.classList.add('hidden');

        // filter rows
        let noResults = true;
        for (const row of table.querySelectorAll('tbody tr')) {
            // show the row by default
            let show = true;

            // if the binary name does not match do not show the row
            if (!row.dataset.name.match(binPattern)) {
                show = false;
            }
            // if there are function filters at least one mush match
            else {
                // fetch the functions buttons
                const functionElems = row.children[1].firstElementChild.children;

                // reset functions class
                for (const item of functionElems) {
                    item.classList.remove('match');
                }

                // try each of the given patterns
                for (const pattern of functionPatterns) {
                    // skip empty filters
                    if (!pattern) {
                        continue;
                    }

                    // check against the pattern
                    let noMatches = true;
                    for (const item of functionElems) {
                        if (item.dataset.name.toLowerCase().match(pattern.toLowerCase())) {
                            item.classList.add('match');
                            noMatches = false;
                        }
                    }

                    // no function satisfies the pattern
                    if (noMatches) {
                        show = false;
                    }
                }
            }

            // hide or show the row
            if (show) {
                row.classList.remove('hidden');
                noResults = false;
            } else {
                row.classList.add('hidden');
            }
        }

        // update the message visibility
        const header = table.querySelector('thead');
        const footer = table.querySelector('tfoot');
        if (noResults) {
            header.classList.add('hidden');
            footer.classList.remove('hidden');
        } else {
            header.classList.remove('hidden');
            footer.classList.add('hidden');
        }

        // restore the table visibility
        table.classList.remove('hidden');
    }

    function applyFilter() {
        // filter on load according to the URL
        const searchBox = document.getElementById('bin-search');
        const query = decodeURIComponent(location.hash.slice(1));
        filter(query);

        // if there is a filter fill the box and enter search mode
        if (query) {
            searchBox.value = query;
            searchBox.focus();
            searchBox.parentElement.scrollIntoView();
        }
    }

    function setup() {
        const searchBox = document.getElementById('bin-search');

        // handle user input
        searchBox.addEventListener('input', () => {
            const query = searchBox.value;
            history.replaceState(null, null, encodeURI(`#${query}`));
            applyFilter();
        });

        // handle shortcuts
        addEventListener('keydown', (event) => {
            // focus search box on valid keydown (search as you type)
            if (event.key.toLowerCase().match(/^[+a-z]$/) && !(event.ctrlKey || event.altKey || event.metaKey)) {
                searchBox.focus();
            } else if (event.key === 'Escape') {
                // if the search box is already focused and empty scroll to top
                if (document.activeElement === searchBox && searchBox.value === '') {
                    window.scrollTo(0, 0);
                    searchBox.blur();
                }
                // clear filter and enter search mode
                else {
                    searchBox.focus();
                    location.hash = searchBox.value = '';
                    searchBox.parentElement.scrollIntoView();
                }
            } else if (event.key === 'Enter') {
                // navigate to the first match
                const firstMatch = document.querySelector('#bin-table tbody tr:not(.hidden) td a');
                if (firstMatch) {
                    firstMatch.click();
                }
            }
        });

        // handle URL changes
        window.onhashchange = applyFilter;

        // trigger filter on page load
        applyFilter();
    }

    setup();
</script>
